# 图片同步系统 - 工作小结

## 项目概述

本项目实现了一个图片同步系统，包含客户端同步脚本和服务端图片服务器，支持从 Oracle 数据库增量拉取图片任务，并通过网络下载图片文件。

---

## 一、客户端同步脚本 (sync_pictures.py)

### 功能概述
从 Oracle 数据库增量拉取图片任务记录，并通过网络从服务器下载对应的图片文件到本地。

### 核心功能

#### 1. 增量数据同步
- 从 `jlyxz.PIC_MATCHTASK` 表查询新的任务记录
- 支持基于 `CREATED_TIME` 和 `TASK_ID` 的增量查询
- 自动保存处理进度，支持断点续传
- 每 300 秒（5分钟）自动轮询一次数据库

#### 2. 图片下载
- 支持下载每个任务的 8 张图片：
  - 4 张 TARE 图片（TARE_IMAGE_PATH1-4）
  - 4 张 GROSS 图片（GROSS_IMAGE_PATH1-4）
- 自动创建本地目录结构，保持与服务器路径一致
- 智能跳过已存在的文件，避免重复下载
- 通过 TCP Socket 从服务器下载图片文件

#### 3. 自动重启机制
- **宕机自动重启**：捕获所有未处理的异常，自动重启程序
- **长时间无下载自动重启**：超过 2 小时没有下载任何文件时自动重启
- 重启前等待 10 秒，便于查看日志和调试

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MAX_NO_DOWNLOAD_HOURS` | 2 | 超过多少小时没有下载就重启 |
| `RESTART_DELAY_SECONDS` | 10 | 重启前等待的秒数 |
| `LOCAL_ROOT` | `D:\\` | 本地保存根目录 |
| `PROGRESS_FILE` | `D:\project\data_tran\sync_progress.json` | 进度文件路径 |

### 进度跟踪

进度文件 `sync_progress.json` 包含：
- `last_created_time`：最后处理的记录创建时间
- `last_task_id`：最后处理的任务ID
- `last_download_time`：最后一次成功下载的时间

### 工作流程

1. 启动服务，每 300 秒轮询一次数据库
2. 查询新的任务记录（基于上次处理进度）
3. 对每条记录，下载所有相关的图片文件
4. 每处理完一条记录，立即保存进度
5. 每次轮询前检查是否需要重启（长时间无下载）
6. 发生异常时自动重启程序

### 使用说明

```bash
python sync_pictures.py
```

程序会持续运行，自动处理新的图片任务。使用 `Ctrl+C` 可以正常退出。

---

## 二、服务端图片服务器 (server.py)

### 功能概述
提供图片文件传输服务，接收客户端请求，从服务器本地文件系统读取图片文件并发送给客户端。

### 核心功能

#### 1. 文件传输服务
- 监听指定端口（默认 5000），等待客户端连接
- 接收客户端发送的完整文件路径
- 检查文件是否存在且可读
- 通过 TCP Socket 发送文件内容给客户端
- 支持多客户端并发连接

#### 2. 文件验证
- 检查文件是否存在
- 检查文件是否可读
- 文件不存在或不可读时，返回明确的错误响应

#### 3. 自动重启机制
- **宕机自动重启**：捕获所有未处理的异常，自动重启服务器
- **异常自动重启**：处理客户端请求时发生异常，自动重启服务器
- **长时间无发送自动重启**：超过 24 小时没有向客户端发送任何数据时自动重启
- 重启前等待 10 秒，便于查看日志

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MAX_NO_SEND_HOURS` | 24 | 超过多少小时没有发送数据就重启 |
| `RESTART_DELAY_SECONDS` | 10 | 重启前等待的秒数 |
| `PROGRESS_FILE` | `server_progress.json` | 进度文件路径（保存最后发送时间） |

### 进度跟踪

进度文件 `server_progress.json` 包含：
- `last_send_time`：最后一次成功发送数据的时间

### 工作流程

1. 启动服务器，监听指定端口
2. 等待客户端连接
3. 接收客户端请求的文件路径
4. 检查文件可读性
5. 发送文件内容给客户端
6. 成功发送后更新最后发送时间
7. 每次接受连接前检查是否需要重启（长时间无发送）
8. 发生异常时自动重启服务器

### 使用说明

```bash
python server.py
```

服务器会持续运行，等待客户端连接。使用 `Ctrl+C` 可以正常退出。

---

## 三、系统特性总结

### 可靠性保障

1. **自动重启机制**
   - 客户端：宕机重启 + 长时间无下载重启
   - 服务端：宕机重启 + 异常重启 + 长时间无发送重启

2. **进度持久化**
   - 客户端和服务端都保存处理进度
   - 支持断点续传，重启后继续处理

3. **异常处理**
   - 完善的异常捕获和日志记录
   - 自动恢复机制，确保服务持续运行

### 性能优化

1. **增量同步**：只处理新数据，避免重复处理
2. **文件去重**：跳过已存在的文件，节省带宽和时间
3. **智能轮询**：可配置轮询间隔，平衡实时性和资源消耗

### 可维护性

1. **配置参数化**：关键参数可配置，便于调整
2. **详细日志**：记录处理过程和异常信息
3. **进度跟踪**：可查看处理进度和状态

---

## 四、文件结构

```
data_tran/
├── sync_pictures.py          # 客户端同步脚本
├── server.py                  # 服务端图片服务器
├── client.py                  # 客户端网络请求模块
├── data_output.py             # 数据库连接模块
├── sync_progress.json         # 客户端进度文件
├── server_progress.json       # 服务端进度文件
└── 工作小结.md                # 本文档
```

---

## 五、技术栈

- **Python 3.x**
- **Oracle 数据库**：使用 `cx_Oracle` 连接
- **Pandas**：数据处理
- **Socket 编程**：网络文件传输
- **JSON**：进度数据持久化

---

## 六、注意事项

1. **数据库连接**：确保 Oracle Instant Client 已正确配置
2. **网络配置**：确保客户端和服务端网络互通
3. **文件权限**：确保服务端有读取图片文件的权限
4. **磁盘空间**：确保本地有足够的存储空间
5. **防火墙**：确保服务端端口（默认 5000）未被防火墙阻止

---

## 七、后续优化建议

1. 添加配置文件支持，便于环境切换
2. 添加邮件或短信告警功能
3. 添加性能监控和统计功能
4. 支持多线程/多进程下载，提升下载速度
5. 添加 Web 管理界面，便于监控和管理

---

## 八、问题修复记录

### 2025-12-28 - 修复 PATH 环境变量超长导致数据库连接失败问题

#### 问题描述
程序在长时间运行后，出现数据库连接失败错误：`the environment variable is longer than 32767 characters`。该问题导致图片同步服务无法正常工作。

#### 问题原因
1. **环境变量无限累加**：`data_output.py` 中的 `connect_to_oracle()` 函数每次调用时都会在 `PATH` 环境变量前追加 Oracle Instant Client 路径
2. **进程重启继承问题**：`sync_pictures.py` 使用 `os.execl()` 重启时，会继承当前进程的所有环境变量，包括已经超长的 `PATH`
3. **Windows 限制**：Windows 系统对单个环境变量的长度限制为 32767 个字符，超过此限制会导致环境变量操作失败

#### 修复方案

**1. 环境变量管理优化 (`data_output.py`)**
- 添加 `_ensure_oracle_env()` 函数，确保 Oracle 环境变量只设置一次
- 实现 PATH 去重机制，避免重复路径累积
- 自动检测 PATH 长度，超过 30000 字符时自动清理，只保留必要路径
- 多层容错机制：
  - 正常模式：去重所有路径
  - 强制清理模式：只保留系统关键路径和 Python 路径
  - Windows API 兜底：使用 `SetEnvironmentVariableW` API 直接设置环境变量

**2. 重启机制优化 (`sync_pictures.py`)**
- 改用 `subprocess.Popen` 重启程序，明确传递清理后的环境变量
- 重启前主动清理 PATH，只保留必要路径（Windows 系统路径、Python 路径）
- 失败回退机制：`subprocess` 失败时回退到 `os.execl`，但先清理当前进程的 PATH

#### 修复效果
- ✅ 彻底解决 PATH 环境变量无限累加问题
- ✅ 自动检测和清理超长环境变量，防止超过 Windows 限制
- ✅ 重启时不再继承损坏的环境变量，确保新进程环境干净
- ✅ 多层容错机制，确保在各种异常情况下都能正常工作

#### 技术要点
- 环境变量长度检测和自动清理
- PATH 去重算法（基于路径小写去重）
- Windows API 直接操作环境变量（`SetEnvironmentVariableW`）
- 进程重启时环境变量的正确传递

#### 注意事项
- 如果当前进程的 PATH 已经损坏，需要先关闭进程再重新启动
- 修复后的代码会自动处理环境变量问题，无需手动干预

